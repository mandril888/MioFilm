angular.module( 'myAngularWeb', [ 'ngRoute', 'controllers', 'config', 'services', 'ngStorage' ] )
angular.module( 'config', [ ] )
	.config( function( $routeProvider ){
			$routeProvider
				.when('/',{
					templateUrl: 'modules/home/home.html',
				})
				.when('/home',{
					templateUrl: 'modules/home/home.html',
				})
				.when('/specifications/:FILMID',{
					templateUrl: 'modules/specifications/specifications.html',
					controller: 'specificationsController'
				})
				.when('/login',{
					templateUrl: 'modules/login/login.html',
					controller: 'loginController'
				})
				.when('/signup',{
					templateUrl: 'modules/signup/signup.html',
					controller: 'signupController'
				})
				.when('/profile',{
					templateUrl: 'modules/profile/profile.html',
					controller: 'profileController'
				})
				.otherwise({ redirectTo: '/' }); ;
	})
angular.module( 'controllers', [ 'headerModuleCtrl', 'homeModuleCtrl', 'specificationsModuleCtrl', 'loginModuleCtrl', 'signupModuleCtrl', 'profileModuleCtrl' ] )
angular.module( 'services', [ 'homeService', 'specificationsService', 'loginService', 'signupService', 'profileService' ] );
angular.module( 'headerModuleCtrl', [ ] )
	.controller( 'headerController' , function ( $localStorage, $scope ) {

		$scope.storage = $localStorage;

		if ($localStorage.token) { // || tokenRecived
			$('#hi-user').css('display', 'block')
			var infoToken = parseJwt($localStorage.token);
			$scope.hiUserName = infoToken._doc.name;
		}

		$scope.$on('insertNameHeader', function(evt, message){
			$('#hi-user').css('display', 'block')
			var infoToken = parseJwt(message);
			$scope.hiUserName = infoToken._doc.name;
		})

		$scope.$on('insertNameHeader2', function(evt, message){
			$('#hi-user').css('display', 'block');
			$('#basicModal').modal('show');
			var infoToken = parseJwt(message);
			$scope.hiUserName = infoToken._doc.name;
		})

		function parseJwt (token) {
			var base64Url = token.split('.')[1];
			var base64 = base64Url.replace('-', '+').replace('_', '/');
			return JSON.parse(window.atob(base64));
		};

	})
angular.module( 'loginModuleCtrl', [ ] )
	.controller( 'loginController' , function ( $localStorage, $rootScope, $scope, $location, loginService ) {

		$scope.storage = $localStorage;
		console.log($localStorage.token)
		if ($localStorage.token) {
			$location.path( 'profile' )
		}

		$scope.submit = function() {
			$('.failed-sign-log').css('display', 'none');
			var user = {
				userName: $scope.userName,
				userPassword: $scope.userPassword
			}
			console.log('User: '+user.userName+' '+user.userPassword)
			loginService.login( user )
				.then( function( data ) {
					console.log(data)
					if (data.data.success === true) {
						$scope.storage.token = data.data.token;
						console.log( 'LOGIN CORRECT' );
						$rootScope.$broadcast('insertNameHeader', data.data.token);
						$location.path( 'profile' );
					} else if (data.data.success === false){
						console.log( 'LOGIN INCORRECT' );
						$location.path( 'login' );
						$('.failed-sign-log').css('display', 'block');
					}
				})
		}
	})
angular.module( 'loginService', [ ] )
	.factory('loginService', function( $http ) {
		function login( user ) {
			return $http.post( '/api/authenticate', user )
		}
		return {
			login: login
		}
	})
angular.module( 'signupModuleCtrl', [ ] )
	.controller( 'signupController' , function ( $localStorage, $rootScope, $scope, $location, signupService ) {

		$scope.storage = $localStorage;
		console.log($localStorage.token)
		if ($localStorage.token) {
			$location.path( 'profile' )
		}

		$scope.submit = function() {
			$('.failed-sign-log').css('display', 'none');
			var user = {
				userName: $scope.userName,
				userPassword: $scope.userPassword
			}
			console.log('User: '+user.userName+' '+user.userPassword)
			signupService.signup( user )
				.then( function( data ) {
					console.log(data)
					if (data.data.success === true) {
						$scope.storage.token = data.data.token;
						console.log( 'signup CORRECT' );
						$rootScope.$broadcast('insertNameHeader2', data.data.token);
						$location.path( 'home' );
					} else if (data.data.success === false){
						console.log( 'signup INCORRECT' );
						$location.path( 'signup' );
						$('.failed-sign-log').css('display', 'block');
					}
				})
		}
	})
angular.module( 'signupService', [ ] )
	.factory('signupService', function( $http ) {
		function signup( user ) {
			console.log('service signup')
			return $http.post( '/new-user', user )
		}
		return {
			signup: signup
		}
	})
angular.module( 'profileModuleCtrl', [ ] )
	.controller( 'profileController' , function ( $localStorage, $scope, $location, profileService ) {

		if (!$localStorage.token) {
			$location.path( 'login' )
		}

		$scope.imageNotFoundCover = '../../img/image-not-found-cover.jpg';
		console.log($localStorage.token)
		$scope.infoFilmSeen = [];

		function parseJwt (token) {
			var base64Url = token.split('.')[1];
			var base64 = base64Url.replace('-', '+').replace('_', '/');
			return JSON.parse(window.atob(base64));
		};

		console.log('in the profileController')

		var infoToken = parseJwt($localStorage.token);
		console.log('paso1: '+infoToken._doc.name)
		var nameUser = {nameUser:infoToken._doc.name}
		profileService.getInfoUser(nameUser)
			.then(function ( userFilmsWatched ){
				console.log('user films seen:'+userFilmsWatched)
				console.log(userFilmsWatched.data)
				if(userFilmsWatched.data.length!==0){
					userFilmsWatched.data.forEach(function(item){
						profileService.getSpecificationsFilm( item.idFilm )
							.then( function ( dataFilmSearched ){
								console.log(dataFilmSearched)
								var userInfoFilm = {
									id: dataFilmSearched.data.id,
									poster_path: dataFilmSearched.data.poster_path,
									original_title: dataFilmSearched.data.original_title,
									mood: item.mood,
									rate: item.rate
								}
								$scope.infoFilmSeen.push(userInfoFilm);
							})
					})
				} else {
					$('.no-films-stored').css('display', 'block')
				}
			})

		$scope.logout = function(){
			console.log('logout')
			window.location.reload(true);
			localStorage.clear();
		}
	})
angular.module( 'profileService', [ ] )
	.factory('profileService', function( $http ) {

		var urlToSearchFilm = 'http://api.themoviedb.org/3/movie/<ID_MOVIE>?api_key=71bd8c83c5cc06c197435d2165ac52e4';

		function getSpecificationsFilm ( idFilmToSearch ) {
			var urlToSearchFilmChanged = urlToSearchFilm.replace('<ID_MOVIE>', idFilmToSearch)
			console.log(urlToSearchFilmChanged)
			return $http.get( urlToSearchFilmChanged )
		}

		function getInfoUser( nameUser ) {
			console.log('paso2: '+nameUser)
			return $http.post( '/api/info-user', nameUser )
		}

		function deleteMovie ( filmToDelete ) {
			console.log('paso2: '+filmToDelete)
			return $http.post( '/api/delete-film', filmToDelete )
		}

		return {
			getSpecificationsFilm : getSpecificationsFilm,
			getInfoUser : getInfoUser,
			deleteMovie : deleteMovie
		}

	})
angular.module( 'profileModuleCtrl' )
	.controller( 'listFilmsProfileController' , function ( $localStorage, $scope, $location, profileService ) {

		function parseJwt (token) {
			var base64Url = token.split('.')[1];
			var base64 = base64Url.replace('-', '+').replace('_', '/');
			return JSON.parse(window.atob(base64));
		};

		console.log('in the listFilmsProfileController')

		$scope.removeFilm = function ( idFilm ) {
			var idFilmToRemove = idFilm;
			console.log('film selected to delete: '+idFilmToRemove)
			var infoToken = parseJwt($localStorage.token);
			console.log('NAME: '+infoToken._doc.name)
			var filmToDelete = {
				nameUser: infoToken._doc.name,
				filmToDelete: idFilmToRemove
			}
			profileService.deleteMovie(filmToDelete)
				.then(function ( userFilmsWatched ){
					console.log('films deleted');
					location.reload();
				})
		}
	})
angular.module( 'homeModuleCtrl', [ ] )
angular.module( 'homeService', [ ] )
angular.module( 'homeModuleCtrl' )
	.controller( 'searcherController' , function ( $rootScope, $scope, $http, searcherService ) {

		$scope.submit = function() {
			$('.questions-to-filter').css('display', 'none');
			$('.list-films').css('display', 'flex')
			$('html, body').animate({
				scrollTop: $('.list-films').offset().top
			}, 1000);
			$('.insert-text').html('<h1>You have searched: <span class="item-searched">' + $scope.filmToSearch + '</span></h1>')

			searcherService.getInfoFilm( $scope.filmToSearch )
				.then( function ( dataFilmSearched ){
					$rootScope.$broadcast('infoFilmSearched', dataFilmSearched.data.results);
				})
		}
	})
angular.module( 'homeService' )
	.factory('searcherService', function( $http ) {

		var urlToSearchFilm = 'http://api.themoviedb.org/3/search/movie?api_key=71bd8c83c5cc06c197435d2165ac52e4&query=<SEARCH>';

		function getInfoFilm ( filmToSearch ) {
			var urlToSearchFilmChanged = urlToSearchFilm.replace('<SEARCH>', filmToSearch)
			return $http.get( urlToSearchFilmChanged )
		}

		return {
			getInfoFilm : getInfoFilm
		}
	})
angular.module( 'homeModuleCtrl' )
	.controller( 'moodsController' , function ( $rootScope, $scope ) {

		$scope.filterSelectedFeelsMood = function( mood ) {
			$('.questions-to-filter').css('display', 'block');
			$('.questions-to-filter').animate({
				'height': '100%',
			}, 1500);
			$('#question1').css('display', 'block');
			$('#question2').css('display', 'none');
			$('#question3').css('display', 'none');
			$('#question4').css('display', 'none');
			$('.list-films').css('display', 'none');

			var moodFeelingSend = mood;
			$rootScope.$broadcast('moodFeelingSend', moodFeelingSend);
		}

		$('.go-dawn').on('click', function(event){
			event.preventDefault();
			$('html, body').animate({
				scrollTop: $('.to-move-scroll').offset().top
			}, 1500);
		});
	})
angular.module( 'homeModuleCtrl' )
	.controller('listFilmsController', function( $rootScope, $scope ) {
		$scope.imageNotFoundCover = '../../img/image-not-found-cover.jpg';
		$scope.$on('infoFilmSearched', function(evt, message){
			$scope.infoFilmToList = message;
		})
		$scope.$on('infoFilmSearchedByMood', function(evt, message){
			console.log('moods')
			$scope.infoFilmToList = message;
		})
		$('.go-top').on('click', function(event){
			event.preventDefault();
			$('html, body').animate({
				scrollTop: 0 }, 1500);
		});
	})
angular.module( 'homeModuleCtrl' )
	.controller( 'question1Controller' , function ( $rootScope, $scope ) {

		$scope.visible = false;

		var oMoodsOpposite = {
			Mad: 'Scared',
			Scared: 'Mad',
			Joyful: 'Powerful',
			Powerful: 'Joyful',
			Peaceful: 'Sad',
			Sad: 'Peaceful',
		}

		var moodFeelingRecived = '';
		var moodSearch = '';

		$scope.$on('moodFeelingSend', function(evt, message){
			moodFeelingRecived = message;
		})

		$scope.filterSetMoodFilm = function ( info ) {
			$('#question2').css('display', 'block');
			$('#question1').css('display', 'none');

			if ( info === 'mood') {
				moodSearch = moodFeelingRecived;
			} else {
				moodSearch = oMoodsOpposite[moodFeelingRecived];
			}

			$rootScope.$broadcast('moodSearchSend', moodSearch);
		}

	})
angular.module( 'homeModuleCtrl' )
	.controller( 'question2Controller' , function ( $rootScope, $scope ) {

		var oTime = {};

		$scope.filterSetDurationFilm = function ( minDuration, maxDuration ) {
			$('#question3').css('display', 'block');
			$('#question2').css('display', 'none');

			oTime = {
				minTime: minDuration,
				maxTime: maxDuration
			}

			$rootScope.$broadcast('oTimeSend', oTime);
		}
	})
angular.module( 'homeModuleCtrl' )
	.controller( 'question3Controller' , function ( $rootScope, $scope ) {

		var yearLimit = '';

		$scope.filterSetProduced = function ( timeProduced ) {
			$('#question4').css('display', 'block');
			$('#question3').css('display', 'none');

			yearLimit = timeProduced;

			$rootScope.$broadcast('yearLimitSend', yearLimit);
		}
	})
angular.module( 'homeModuleCtrl' )
	.controller( 'question4Controller' , function ( $rootScope, $scope, $http, questionsService, $q ) {

		//Predefined values to the Filter
		var numberFilmsToSearch = 6;
		var numVotesMinimum = 10;
		var rateToFilter = 5;
		//Input values of the Filter
		var moodSearchRecived = "";
		var minTimeRecived = "";
		var maxTimeRecived = "";
		var yearLimitRecived = "";

		$scope.$on('moodSearchSend', function(evt, message){
			moodSearchRecived = message;
		})
		$scope.$on('oTimeSend', function(evt, message){
			minTimeRecived = message.minTime;
			maxTimeRecived = message.maxTime;
		})
		$scope.$on('yearLimitSend', function(evt, message){
			yearLimitRecived = message;
		})

		$scope.searchFilmWithFilter = function() {
			$('.list-films').css('display', 'flex')
			$('.insert-text').html('<h1>You have searched: <span class="item-searched">' + moodSearchRecived + '</span></h1>')
			$('#question4 span').html('Repeat the search');
			$('html, body').animate({
				scrollTop: $('.to-move-scroll').offset().top
			}, 1000);

			var moodNumber;
			if ( moodSearchRecived === 'Sad' ) { moodNumber = '80|18|10752';
			} else if ( moodSearchRecived === 'Joyful') { moodNumber = '12|16|35|10751|14|10402|10749';
			} else if ( moodSearchRecived === 'Mad') { moodNumber = '28|80|53|10752';
			} else if ( moodSearchRecived === 'Powerful') { moodNumber = '28|12|14|9648|878|53';
			} else if ( moodSearchRecived === 'Scared') { moodNumber = '80|27|9648';
			} else if ( moodSearchRecived === 'Peaceful') { moodNumber = '99|10751|14|36|10402|10749';
			}

			var aFilmsFiltered = [];

			questionsService.getInfoFilmByMood( moodNumber )
				.then( function( data ) {
					filterFilms( data, moodNumber, aFilmsFiltered )
				})
		}

		function filterFilms ( dataFilmSearched, moodNumber, aFilmsFiltered ) {
			var promisesDetailsFilms = [];
			dataFilmSearched.data.results.forEach(function (item, i) {
				var singleFilmSearched = item;
				if( singleFilmSearched.vote_count >= numVotesMinimum ) {
					if( singleFilmSearched.vote_average >= rateToFilter ){
						var yearShootFilm = singleFilmSearched.release_date.slice(0,4);
						if( yearShootFilm >= yearLimitRecived ) {
							var promise = questionsService.getSpecificationsFilm( singleFilmSearched.id );
							promisesDetailsFilms.push(promise);
						}
					}
				}
			})
			$q.all( promisesDetailsFilms )
				.then( function ( aDataFilmSearched ){
					aDataFilmSearched.forEach( function (item, i) {
						var durationFilm = item.data.runtime;
						if ( durationFilm >= minTimeRecived && durationFilm <= maxTimeRecived ) {
							if( aFilmsFiltered.length < numberFilmsToSearch ) {
								return aFilmsFiltered.push( item.data );
							}
						}
					})
				})
			if ( aFilmsFiltered.length < numberFilmsToSearch ) {
				questionsService.getInfoFilmByMood( moodNumber )
					.then( function( data ) {
						filterFilms( data, moodNumber, aFilmsFiltered )
					})
			}

			$rootScope.$broadcast('infoFilmSearchedByMood', aFilmsFiltered);
		}
	})
angular.module( 'homeService' )
	.factory('questionsService', function( $http ) {

		var urlToSearchFilmByMood = 'https://api.themoviedb.org/3/discover/movie?api_key=71bd8c83c5cc06c197435d2165ac52e4&with_genres=<MOOD_NUM>&page=<PAGE>';

		function getInfoFilmByMood ( moodNumber ) {
			var randomPage = Math.floor(Math.random() * 1000) + 1;
			var mapObj = {
				'<MOOD_NUM>': moodNumber,
				'<PAGE>': randomPage
			};
			var urlToSearchFilmByMoodChanged = urlToSearchFilmByMood.replace(/<MOOD_NUM>|<PAGE>/gi, function(matched){
				return mapObj[matched];
			});

			return promise = $http.get( urlToSearchFilmByMoodChanged )
		}

		// REVISAR - esta petici√≥n es la misma que la de specificationsService
		var urlToGetInfoFilm = 'http://api.themoviedb.org/3/movie/<ID_MOVIE>?api_key=71bd8c83c5cc06c197435d2165ac52e4';

		function getSpecificationsFilm ( idFilmToSearch ) {
			var urlToSearchFilmChanged = urlToGetInfoFilm.replace('<ID_MOVIE>', idFilmToSearch)
			return $http.get( urlToSearchFilmChanged ) // return a promise
		}

		return {
			getInfoFilmByMood : getInfoFilmByMood,
			getSpecificationsFilm : getSpecificationsFilm
		}

	})
angular.module( 'specificationsModuleCtrl', [ ] )
	.controller( 'specificationsController' , function ( $scope, $http, $routeParams, specificationsService ) {

		$scope.imageNotFoundCover = '../../img/image-not-found-cover.jpg';
		$scope.imageNotFoundHeaderCover = '../../img/image-not-found-header-cover.jpg';
		$scope.specificationsFilmSearched = "";
		var filmId = $routeParams.FILMID;

		specificationsService.getSpecificationsFilm( filmId )
			.then( function ( dataFilmSearched ){
				$scope.specificationsFilmSearched = dataFilmSearched.data;
			})
	})
angular.module( 'specificationsService', [ ] )
	.factory('specificationsService', function( $http ) {

		var urlToSearchFilm = 'http://api.themoviedb.org/3/movie/<ID_MOVIE>?api_key=71bd8c83c5cc06c197435d2165ac52e4';

		function getSpecificationsFilm ( idFilmToSearch ) {
			var urlToSearchFilmChanged = urlToSearchFilm.replace('<ID_MOVIE>', idFilmToSearch)
			console.log(urlToSearchFilmChanged)
			return $http.get( urlToSearchFilmChanged )
		}

		function postInfoSeenFilms( infoFilmSeen ) {
			console.log(infoFilmSeen)
			return $http.post( '/api/film-seen', infoFilmSeen )
		}

		return {
			getSpecificationsFilm : getSpecificationsFilm,
			postInfoSeenFilms : postInfoSeenFilms
		}

	})
angular.module( 'specificationsModuleCtrl' )
	.controller( 'moodFilmController' , function ( $localStorage, $scope, $rootScope ) {

		$scope.moodFelt = function (mood) {
			console.log(mood)
			if ($localStorage.token) {
				$rootScope.$broadcast('moodSend', mood);
			} else {
				$('.not-logged').css('display', 'block')
			}
		}
	})
angular.module( 'specificationsModuleCtrl' )
	.controller( 'rateFilmController' , function ( $localStorage, $scope, $rootScope ) {

		$scope.rate = function (rate) {
			console.log(rate)
			if ($localStorage.token) {
				$rootScope.$broadcast('rateSend', rate);
			} else {
				$('.not-logged').css('display', 'block')
			}
		}
	})
// angular.module( 'specificationsModuleCtrl' )
// 	.controller( 'seeFilmController' , function ( $localStorage, $scope, $rootScope ) {

// 		$scope.movieSeen = function (idFilm) {
// 			console.log(idFilm)
// 			if ($localStorage.token) {
// 				$('.img-imagotipo').attr("src","../../img/miofilm-imagotipo.png");
// 				$rootScope.$broadcast('seeFilmSend', idFilm);
// 			} else {
// 				$('.not-logged').css('display', 'block')
// 			}
// 		}
// 	})
angular.module( 'specificationsModuleCtrl' )
	.controller( 'sendInfoSeenFilmController' , function ( $localStorage, $scope, $http, specificationsService ) {

		var idFilmRecived = "";
		var rateRecived;
		var moodRecived = "";

		// $scope.$on('seeFilmSend', function(evt, message){
		// 	idFilmRecived = message;
		// })
		$scope.$on('rateSend', function(evt, message){
			rateRecived = message;
		})
		$scope.$on('moodSend', function(evt, message){
			moodRecived = message;
		})

		$scope.sendInfoSeenFilm = function ( idFilm ) {
			$('.not-info-complete').css('display', 'none')
			$('.info-complete').css('display', 'none')
			$('.not-logged').css('display', 'none')
			console.log('csdvefrgvqliebvqijbdv')

			var idFilmRecived = idFilm;

			if ($localStorage.token) {
				if(idFilmRecived && rateRecived && moodRecived) {
					var infoUser = parseJwt($localStorage.token);
					var nameUser = infoUser._doc.name;
					var infoFilmSeen = {
						nameUser: nameUser,
						idFilm: idFilmRecived,
						rate: rateRecived,
						mood: moodRecived
					}
					specificationsService.postInfoSeenFilms( infoFilmSeen )
						.then( function( data ) {
							console.log(data)
							$('.not-info-complete').css('display', 'none')
							$('.info-complete').css('display', 'block')
						})
				} else {
					$('.not-info-complete').css('display', 'block')
				}
			} else {
				$('.not-logged').css('display', 'block')
			}
		}

		function parseJwt (token) {
			var base64Url = token.split('.')[1];
			var base64 = base64Url.replace('-', '+').replace('_', '/');
			return JSON.parse(window.atob(base64));
		};
	})